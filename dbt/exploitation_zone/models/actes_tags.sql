{{ config(materialized='table')}}

with format_json as (
    select
    "acte_id" as id,
    cast(regexp_replace(
    regexp_replace( regexp_replace( "grup_adreca", E'\'([a-zA-Z_]+)\': \'\'', E'"\\1": null', 'g' ), E'\'([a-zA-Z_]+)\': \'([^\']+)\'', E'"\\1": "\\2"','g'),
    E'\'([a-zA-Z_]+)\':', E'"\\1":', 'g'
      ) as json) AS grup_adreca
    from raw.actes_turisme at2 

)
select
"acte_id" as id,
replace(unnest(string_to_array(replace(replace("tags",'[', ''), ']',''), ',')),'''', '') as tags
from exploitation_zone.raw.actes_turisme a
left join format_json b on a."acte_id" = b."id"
